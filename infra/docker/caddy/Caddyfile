:80 {
  # CORS preflight handler (global)
  @preflight method OPTIONS
  header @preflight Access-Control-Allow-Origin "*"
  header @preflight Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
  header @preflight Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN"
  header @preflight Access-Control-Allow-Credentials "true"
  respond @preflight 204

  # API & Sanctum → PHP-FPM (Laravel) sous /api et /sanctum uniquement
  @api path /api* /sanctum*
  handle @api {
    root * /var/www/html/public
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN"
    header Access-Control-Allow-Credentials "true"
    php_fastcgi app:9000
    file_server
  }

  # SPA static (frontend/dist) servie à la racine
  handle {
    root * /var/www/frontend/dist
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN"
    header Access-Control-Allow-Credentials "true"
    encode gzip

    @file file {path}
    handle @file {
      file_server
    }

    handle {
      rewrite * /index.html
      file_server
    }
  }
}
